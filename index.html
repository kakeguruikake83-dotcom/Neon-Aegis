<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>AEGIS DEFENSE ‚Äî Tower Defense</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Exo+2:wght@300;400;600;700;900&family=Orbitron:wght@400;700;900&display=swap');

  :root {
    --bg: #0a0c12;
    --bg2: #0f1220;
    --bg3: #151a2e;
    --panel: #0d1025cc;
    --border: #1e2d50;
    --accent: #00d4ff;
    --accent2: #ff6b35;
    --accent3: #7c3aed;
    --green: #22c55e;
    --red: #ef4444;
    --yellow: #eab308;
    --gold: #f59e0b;
    --text: #e2e8f0;
    --text2: #94a3b8;
    --glow: 0 0 20px #00d4ff44;
    --glow2: 0 0 20px #ff6b3544;
  }

  * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
  html,body { width:100%; height:100%; overflow:hidden; background:var(--bg); font-family:'Exo 2',sans-serif; color:var(--text); }

  /* ========== SCREENS ========== */
  .screen { position:absolute; inset:0; display:none; flex-direction:column; align-items:center; justify-content:center; }
  .screen.active { display:flex; }

  /* ========== MAIN MENU ========== */
  #menuScreen { background: radial-gradient(ellipse at 50% 30%, #1a0a3e 0%, #0a0c12 70%); }
  #menuScreen canvas { position:absolute; inset:0; }
  .menu-content { position:relative; z-index:10; text-align:center; }
  .game-logo { font-family:'Orbitron',monospace; font-size:clamp(2rem,8vw,5rem); font-weight:900; letter-spacing:0.05em;
    background: linear-gradient(135deg, #00d4ff, #7c3aed, #ff6b35);
    -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;
    text-shadow:none; filter:drop-shadow(0 0 30px #00d4ff66); margin-bottom:0.2em; }
  .game-sub { font-family:'Orbitron',monospace; font-size:clamp(0.6rem,2vw,1rem); letter-spacing:0.4em; color:var(--accent); opacity:0.8; margin-bottom:3rem; }
  .menu-btn { display:block; width:260px; padding:0.9rem 2rem; margin:0.6rem auto; font-family:'Orbitron',monospace; font-size:1rem; font-weight:700;
    background:linear-gradient(135deg, #00d4ff22, #7c3aed22); border:1px solid var(--accent); color:var(--accent);
    cursor:pointer; clip-path:polygon(12px 0,100% 0,calc(100% - 12px) 100%,0 100%);
    transition:all 0.2s; letter-spacing:0.1em; }
  .menu-btn:hover { background:linear-gradient(135deg, #00d4ff44, #7c3aed44); box-shadow:var(--glow); transform:scale(1.03); }
  .menu-btn.primary { background:linear-gradient(135deg, #00d4ff55, #7c3aed55); font-size:1.2rem; padding:1.1rem 2.5rem; }

  /* ========== GAME SCREEN ========== */
  #gameScreen { flex-direction:row; background:var(--bg); }
  #gameCanvas { flex:1; min-width:0; cursor:crosshair; touch-action:none; }
  #sidebar { width:200px; min-width:180px; background:var(--panel); border-left:1px solid var(--border);
    display:flex; flex-direction:column; gap:4px; padding:6px; overflow-y:auto; backdrop-filter:blur(10px); }

  /* ========== HUD ========== */
  #hud { position:absolute; top:0; left:0; right:200px; display:flex; align-items:center; gap:8px;
    padding:6px 10px; background:linear-gradient(180deg,#0a0c12ee,transparent); z-index:20; flex-wrap:wrap; }
  .hud-stat { display:flex; align-items:center; gap:4px; font-family:'Orbitron',monospace; font-size:0.75rem; font-weight:700; }
  .hud-stat .icon { font-size:1rem; }
  .hud-stat .val { color:var(--accent); }
  .hud-sep { width:1px; height:20px; background:var(--border); }
  #waveBtn { margin-left:auto; font-family:'Orbitron',monospace; font-size:0.7rem; padding:5px 14px;
    background:linear-gradient(135deg,#22c55e33,#22c55e11); border:1px solid var(--green); color:var(--green);
    cursor:pointer; clip-path:polygon(8px 0,100% 0,calc(100%-8px) 100%,0 100%); font-weight:700; transition:all 0.2s; }
  #waveBtn:hover { background:linear-gradient(135deg,#22c55e55,#22c55e22); box-shadow:0 0 15px #22c55e44; }
  #waveBtn:disabled { opacity:0.4; cursor:not-allowed; }

  /* ========== SIDEBAR ========== */
  .sidebar-section { font-family:'Orbitron',monospace; font-size:0.55rem; color:var(--text2); letter-spacing:0.2em; text-transform:uppercase; padding:4px 2px 2px; border-bottom:1px solid var(--border); }
  .tower-btn { display:grid; grid-template-columns:40px 1fr; gap:4px; padding:5px; background:var(--bg3);
    border:1px solid var(--border); cursor:pointer; transition:all 0.15s; border-radius:2px; align-items:center; }
  .tower-btn:hover { border-color:var(--accent); background:#1a2240; }
  .tower-btn.selected { border-color:var(--accent); background:#0d2040; box-shadow:inset 0 0 10px #00d4ff22; }
  .tower-btn.locked { opacity:0.4; cursor:not-allowed; }
  .tower-icon { width:36px; height:36px; border-radius:2px; display:flex; align-items:center; justify-content:center; font-size:1.4rem; }
  .tower-info { min-width:0; }
  .tower-name { font-family:'Orbitron',monospace; font-size:0.6rem; font-weight:700; color:var(--text); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .tower-cost { font-size:0.65rem; color:var(--gold); }
  .tower-desc { font-size:0.5rem; color:var(--text2); margin-top:1px; }

  /* Abilities */
  .ability-grid { display:grid; grid-template-columns:1fr 1fr; gap:4px; }
  .ability-btn { padding:5px; background:var(--bg3); border:1px solid var(--border); cursor:pointer;
    transition:all 0.15s; border-radius:2px; text-align:center; position:relative; overflow:hidden; }
  .ability-btn:hover:not(:disabled) { border-color:var(--accent2); }
  .ability-btn:disabled { opacity:0.5; cursor:not-allowed; }
  .ability-btn .abi-icon { font-size:1.2rem; display:block; }
  .ability-btn .abi-name { font-size:0.45rem; font-family:'Orbitron',monospace; color:var(--text2); }
  .ability-btn .abi-cd { font-size:0.5rem; color:var(--accent2); font-weight:700; }
  .ability-cd-bar { position:absolute; bottom:0; left:0; height:2px; background:var(--accent2); transition:width 0.1s linear; }

  /* Speed */
  .speed-grid { display:grid; grid-template-columns:1fr 1fr 1fr; gap:3px; }
  .speed-btn { padding:4px; background:var(--bg3); border:1px solid var(--border); cursor:pointer;
    font-family:'Orbitron',monospace; font-size:0.55rem; color:var(--text2); transition:all 0.15s; border-radius:2px; text-align:center; }
  .speed-btn.active { border-color:var(--accent); color:var(--accent); background:#0d2040; }

  /* Info panel */
  #infoPanel { background:var(--bg3); border:1px solid var(--border); border-radius:2px; padding:6px; font-size:0.55rem; color:var(--text2); min-height:80px; }
  #infoPanel h4 { font-family:'Orbitron',monospace; font-size:0.65rem; color:var(--accent); margin-bottom:4px; }
  #infoPanel .stat-row { display:flex; justify-content:space-between; padding:1px 0; }
  #infoPanel .stat-row span:last-child { color:var(--text); font-weight:600; }
  .upgrade-btn { width:100%; margin-top:4px; padding:4px; background:linear-gradient(135deg,#f59e0b22,#f59e0b11);
    border:1px solid var(--gold); color:var(--gold); cursor:pointer; font-family:'Orbitron',monospace; font-size:0.55rem;
    transition:all 0.15s; border-radius:2px; }
  .upgrade-btn:hover { background:linear-gradient(135deg,#f59e0b44,#f59e0b22); }
  .sell-btn { width:100%; margin-top:3px; padding:3px; background:#ef444411; border:1px solid #ef4444;
    color:#ef4444; cursor:pointer; font-family:'Orbitron',monospace; font-size:0.5rem; transition:all 0.15s; border-radius:2px; }
  .sell-btn:hover { background:#ef444422; }

  /* ========== MODALS ========== */
  .modal-overlay { position:fixed; inset:0; background:#000000cc; z-index:100; display:none; align-items:center; justify-content:center; }
  .modal-overlay.active { display:flex; }
  .modal { background:var(--bg2); border:1px solid var(--border); padding:24px; max-width:500px; width:90%;
    clip-path:polygon(16px 0,100% 0,100% calc(100%-16px),calc(100%-16px) 100%,0 100%,0 16px); }
  .modal h2 { font-family:'Orbitron',monospace; font-size:1.2rem; color:var(--accent); margin-bottom:16px; }
  .modal p { color:var(--text2); line-height:1.6; margin-bottom:12px; font-size:0.9rem; }
  .modal-btns { display:flex; gap:10px; justify-content:flex-end; margin-top:16px; }
  .modal-btn { padding:8px 20px; font-family:'Orbitron',monospace; font-size:0.8rem; cursor:pointer;
    clip-path:polygon(8px 0,100% 0,calc(100%-8px) 100%,0 100%); transition:all 0.2s; border:1px solid; font-weight:700; }
  .modal-btn.confirm { border-color:var(--green); color:var(--green); background:#22c55e11; }
  .modal-btn.confirm:hover { background:#22c55e33; }
  .modal-btn.cancel { border-color:var(--text2); color:var(--text2); background:transparent; }
  .modal-btn.cancel:hover { background:#ffffff11; }

  /* ========== DAMAGE NUMBERS ========== */
  .dmg-num { position:absolute; font-family:'Orbitron',monospace; font-weight:900; pointer-events:none;
    animation:floatUp 1s ease-out forwards; z-index:50; text-shadow:0 0 10px currentColor; }
  @keyframes floatUp { 0%{opacity:1;transform:translateY(0) scale(1)} 100%{opacity:0;transform:translateY(-50px) scale(0.7)} }

  /* ========== NOTIFICATIONS ========== */
  #notifArea { position:absolute; top:50px; left:50%; transform:translateX(-50%); z-index:60; pointer-events:none; display:flex; flex-direction:column; gap:4px; align-items:center; }
  .notif { font-family:'Orbitron',monospace; font-size:0.75rem; padding:6px 16px; background:var(--panel);
    border:1px solid var(--accent); color:var(--accent); animation:notifAnim 2.5s ease-out forwards;
    clip-path:polygon(8px 0,100% 0,calc(100%-8px) 100%,0 100%); }
  @keyframes notifAnim { 0%{opacity:0;transform:translateY(-10px)} 15%{opacity:1;transform:translateY(0)} 70%{opacity:1} 100%{opacity:0;transform:translateY(-20px)} }

  /* ========== WAVE ANNOUNCE ========== */
  #waveAnnounce { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); z-index:70; pointer-events:none; text-align:center; display:none; }
  #waveAnnounce h2 { font-family:'Orbitron',monospace; font-size:clamp(1.5rem,5vw,3rem); font-weight:900; color:var(--accent2); filter:drop-shadow(0 0 20px var(--accent2)); animation:waveAnnouncePop 0.5s ease-out; }
  @keyframes waveAnnouncePop { 0%{transform:scale(0.5);opacity:0} 100%{transform:scale(1);opacity:1} }

  /* ========== GAME OVER ========== */
  #gameOverScreen { background:radial-gradient(ellipse at 50% 50%, #3b0000 0%, #0a0c12 70%); }
  #gameOverScreen h2 { font-family:'Orbitron',monospace; font-size:clamp(2rem,8vw,4rem); font-weight:900; color:var(--red); filter:drop-shadow(0 0 30px var(--red)); margin-bottom:1rem; }
  #gameOverScreen .stats { font-size:1rem; color:var(--text2); margin-bottom:2rem; line-height:2; text-align:center; }
  #gameOverScreen .stats span { color:var(--accent); font-weight:700; }

  /* ========== VICTORY ========== */
  #victoryScreen { background:radial-gradient(ellipse at 50% 50%, #0a3b1a 0%, #0a0c12 70%); }
  #victoryScreen h2 { font-family:'Orbitron',monospace; font-size:clamp(2rem,8vw,4rem); font-weight:900; color:var(--green); filter:drop-shadow(0 0 30px var(--green)); margin-bottom:1rem; }

  /* ========== SCROLLBAR ========== */
  ::-webkit-scrollbar { width:4px; }
  ::-webkit-scrollbar-track { background:var(--bg); }
  ::-webkit-scrollbar-thumb { background:var(--border); border-radius:2px; }

  /* ========== MOBILE ========== */
  @media(max-width:600px) {
    #sidebar { width:160px; min-width:140px; }
    #hud { right:160px; font-size:0.65rem; }
    .tower-icon { width:28px; height:28px; font-size:1rem; }
  }
</style>
</head>
<body>

<!-- MENU -->
<div id="menuScreen" class="screen active">
  <canvas id="menuCanvas"></canvas>
  <div class="menu-content">
    <div class="game-logo">AEGIS</div>
    <div class="game-sub">DEFENSE PROTOCOL</div>
    <button class="menu-btn primary" onclick="startGame()">‚ñ∂ INICIAR MISS√ÉO</button>
    <button class="menu-btn" onclick="showHelp()">üìñ COMO JOGAR</button>
  </div>
</div>

<!-- GAME SCREEN -->
<div id="gameScreen" class="screen">
  <!-- HUD -->
  <div id="hud">
    <div class="hud-stat"><span class="icon">‚ù§Ô∏è</span><span id="livesVal" class="val">20</span></div>
    <div class="hud-sep"></div>
    <div class="hud-stat"><span class="icon">üí∞</span><span id="goldVal" class="val">200</span></div>
    <div class="hud-sep"></div>
    <div class="hud-stat"><span class="icon">‚öîÔ∏è</span><span id="killsVal" class="val">0</span></div>
    <div class="hud-sep"></div>
    <div class="hud-stat"><span class="icon">üåä</span><span id="waveVal" class="val">0</span></div>
    <div class="hud-sep"></div>
    <div class="hud-stat"><span class="icon">üìä</span><span id="scoreVal" class="val">0</span></div>
    <button id="waveBtn" onclick="startWave()">PR√ìXIMA ONDA ‚ñ∂</button>
  </div>

  <!-- CANVAS -->
  <canvas id="gameCanvas"></canvas>

  <!-- SIDEBAR -->
  <div id="sidebar">
    <div class="sidebar-section">Torres</div>
    <div id="towerList"></div>
    <div class="sidebar-section" style="margin-top:6px">Habilidades</div>
    <div class="ability-grid" id="abilityGrid"></div>
    <div class="sidebar-section" style="margin-top:6px">Velocidade</div>
    <div class="speed-grid">
      <button class="speed-btn active" onclick="setSpeed(1)" id="sp1">1x</button>
      <button class="speed-btn" onclick="setSpeed(2)" id="sp2">2x</button>
      <button class="speed-btn" onclick="setSpeed(3)" id="sp3">3x</button>
    </div>
    <div class="sidebar-section" style="margin-top:6px">Info</div>
    <div id="infoPanel"><span style="color:var(--text2);font-size:0.55rem">Selecione uma torre para construir ou clique em uma torre existente.</span></div>
    <button class="menu-btn" style="width:100%;margin-top:8px;font-size:0.6rem;padding:6px" onclick="confirmMenu()">‚¨Ö MENU</button>
  </div>

  <!-- DAMAGE NUMBERS LAYER -->
  <div id="dmgLayer" style="position:absolute;inset:0;pointer-events:none;z-index:30;overflow:hidden"></div>

  <!-- NOTIFICATIONS -->
  <div id="notifArea"></div>

  <!-- WAVE ANNOUNCE -->
  <div id="waveAnnounce"><h2 id="waveAnnounceTxt"></h2></div>
</div>

<!-- GAME OVER -->
<div id="gameOverScreen" class="screen">
  <h2>MISS√ÉO FALHOU</h2>
  <div class="stats" id="goStats"></div>
  <button class="menu-btn primary" onclick="startGame()">‚Ü∫ TENTAR NOVAMENTE</button>
  <button class="menu-btn" onclick="goMenu()" style="margin-top:4px">‚¨Ö MENU</button>
</div>

<!-- VICTORY -->
<div id="victoryScreen" class="screen">
  <h2>VIT√ìRIA!</h2>
  <div class="stats" id="vicStats"></div>
  <button class="menu-btn primary" onclick="startGame()">‚ñ∂ PR√ìXIMA PARTIDA</button>
  <button class="menu-btn" onclick="goMenu()" style="margin-top:4px">‚¨Ö MENU</button>
</div>

<!-- HELP MODAL -->
<div class="modal-overlay" id="helpModal">
  <div class="modal">
    <h2>COMO JOGAR</h2>
    <p>üñ± <b>Construir:</b> Selecione uma torre no painel lateral, depois clique em um espa√ßo livre no mapa (n√£o sobre o caminho).</p>
    <p>üîß <b>Upgrade:</b> Clique em uma torre constru√≠da para ver detalhes e melhor√°-la.</p>
    <p>‚ö° <b>Habilidades:</b> Use as habilidades ativas para situa√ß√µes cr√≠ticas ‚Äî cada uma tem cooldown.</p>
    <p>üåä <b>Ondas:</b> Clique em "PR√ìXIMA ONDA" para iniciar. Ondas iniciam automaticamente ap√≥s 30s.</p>
    <p>üí° <b>Combos:</b> Congelante + Canh√£o causa dano CR√çTICO em inimigos lentos!</p>
    <div class="modal-btns"><button class="modal-btn confirm" onclick="document.getElementById('helpModal').classList.remove('active')">ENTENDIDO</button></div>
  </div>
</div>

<!-- CONFIRM MENU MODAL -->
<div class="modal-overlay" id="confirmMenuModal">
  <div class="modal">
    <h2>SAIR DA MISS√ÉO?</h2>
    <p>Todo progresso desta partida ser√° perdido.</p>
    <div class="modal-btns">
      <button class="modal-btn cancel" onclick="document.getElementById('confirmMenuModal').classList.remove('active')">CANCELAR</button>
      <button class="modal-btn confirm" onclick="goMenu()">CONFIRMAR</button>
    </div>
  </div>
</div>

<script>
// ============================================================
// AEGIS DEFENSE ‚Äî Complete Tower Defense Game
// ============================================================

const C = document.getElementById('gameCanvas');
const ctx = C.getContext('2d');

// ==================== CONSTANTS ====================
const TILE = 48;
let COLS, ROWS;
let gameState = null;
let animFrame = null;
let lastTime = 0;
let gameSpeed = 1;
let selectedTower = null;
let selectedBuiltTower = null;
let hoverCell = null;
let shakeTimer = 0;
let shakeAmt = 0;

// ==================== TOWER DEFINITIONS ====================
const TOWER_DEFS = [
  {
    id:'archer', name:'Arqueira', icon:'üèπ', color:'#22c55e',
    cost:80, dmg:18, range:3.2, spd:1.8, type:'physical',
    desc:'R√°pida, boa vs normais',
    upgrades:[
      {name:'Aljava Maior',cost:60,dmg:8,desc:'+dano'},
      {name:'Flecha Dupla',cost:100,spd:0.5,desc:'+velocidade'},
      {name:'Flecha de Fogo',cost:150,bonus:'burn',desc:'Queima inimigos'}
    ]
  },
  {
    id:'cannon', name:'Canh√£o', icon:'üí£', color:'#f59e0b',
    cost:150, dmg:60, range:2.8, spd:0.7, type:'explosive', aoe:1.2,
    desc:'AOE devastador',
    upgrades:[
      {name:'P√≥lvora Extra',cost:80,dmg:25,desc:'+dano'},
      {name:'Alcance+',cost:120,range:0.5,desc:'+alcance'},
      {name:'Granada Dupla',cost:200,bonus:'double',desc:'2 proj√©teis'}
    ]
  },
  {
    id:'mage', name:'Mago', icon:'üîÆ', color:'#7c3aed',
    cost:200, dmg:40, range:3.0, spd:1.0, type:'magic',
    desc:'Dano m√°gico, ignora armadura',
    upgrades:[
      {name:'Tomo Arcano',cost:100,dmg:20,desc:'+dano m√°gico'},
      {name:'Mente Agu√ßada',cost:150,spd:0.4,desc:'+velocidade'},
      {name:'Bola de Fogo',cost:250,bonus:'fireball',desc:'Proj√©til explosivo'}
    ]
  },
  {
    id:'sniper', name:'Sniper', icon:'üéØ', color:'#00d4ff',
    cost:250, dmg:120, range:6.0, spd:0.4, type:'physical',
    desc:'Longo alcance, alto dano',
    upgrades:[
      {name:'Mira Laser',cost:120,dmg:50,desc:'+dano cr√≠tico'},
      {name:'Silenciador',cost:100,spd:0.2,desc:'+silencioso'},
      {name:'Perfurar',cost:200,bonus:'pierce',desc:'Atravessa inimigos'}
    ]
  },
  {
    id:'frost', name:'Gelo', icon:'‚ùÑÔ∏è', color:'#93c5fd',
    cost:180, dmg:15, range:2.5, spd:1.2, type:'ice', slow:0.5,
    desc:'Congela e desacelera',
    upgrades:[
      {name:'N√©voa Gelada',cost:80,range:0.5,desc:'+alcance'},
      {name:'Gelo Eterno',cost:130,slow:0.2,desc:'+lentid√£o'},
      {name:'Blizzard',cost:220,bonus:'blizzard',desc:'AOE de gelo'}
    ]
  },
  {
    id:'poison', name:'Veneno', icon:'‚ò†Ô∏è', color:'#86efac',
    cost:160, dmg:8, range:2.8, spd:1.5, type:'poison', dot:12,
    desc:'Dano cont√≠nuo por veneno',
    upgrades:[
      {name:'Toxina+',cost:70,dot:6,desc:'+dano/s'},
      {name:'Nuvem T√≥xica',cost:120,bonus:'cloud',desc:'AOE veneno'},
      {name:'Veneno Letal',cost:180,dmg:15,desc:'+dano base'}
    ]
  },
  {
    id:'tesla', name:'Tesla', icon:'‚ö°', color:'#fbbf24',
    cost:300, dmg:35, range:2.5, spd:1.8, type:'electric', chain:3,
    desc:'Corrente el√©trica encadeada',
    upgrades:[
      {name:'Sobrecarga',cost:150,dmg:20,desc:'+dano'},
      {name:'Cadeia+',cost:180,chain:2,desc:'+alvos em cadeia'},
      {name:'Tempestade',cost:250,bonus:'storm',desc:'AOE el√©trica'}
    ]
  },
  {
    id:'antiair', name:'AA', icon:'üöÄ', color:'#f87171',
    cost:220, dmg:50, range:4.0, spd:2.5, type:'ballistic', priority:'air',
    desc:'Anti-a√©reo, 3x vs voadores',
    upgrades:[
      {name:'M√≠ssil Guiado',cost:100,dmg:30,desc:'+dano'},
      {name:'Radar',cost:120,range:1.0,desc:'+alcance'},
      {name:'Salva',cost:200,bonus:'salvo',desc:'3 m√≠sseis simult√¢neos'}
    ]
  }
];

// ==================== ABILITY DEFINITIONS ====================
const ABILITY_DEFS = [
  {id:'meteor',name:'Meteoro',icon:'‚òÑÔ∏è',cooldown:30,color:'#ef4444',desc:'Dano massivo em √°rea'},
  {id:'freeze',name:'Congelar',icon:'üå®Ô∏è',cooldown:25,color:'#93c5fd',desc:'Congela todos por 3s'},
  {id:'reinforce',name:'Refor√ßar',icon:'üõ°Ô∏è',cooldown:20